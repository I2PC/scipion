{% extends 'base_grid.html' %}

{% block title %} - Showj{% endblock %}

{% block content_head %}
<!-- CSS -->
<link href="{{showj_css}}" rel="stylesheet" type="text/css">
<!-- JS -->
<script src="{{jquery_waypoints}}" type="text/javascript"></script>
<script src="{{jquery_hover_intent}}" type="text/javascript"></script>
<script src="{{showj_js}}" type="text/javascript"></script>

<script type="text/javascript">
jQuery(function($) {
	// Just call the inner layout once to initialize it. This
	// must happen before the outer layout is initialized. It
	// will be automatically resized when the outer layout is
	// resized.
	/* 	var outerContainer = $('.layout-outer');

	function layout() {
		outerContainer.layout({resize: false});
	}
	layout();

	$(window).resize(layout); */
	
	var outerContainer = $('.layout-outer');

	function layout() {
		outerContainer.layout({resize: false});
	}
	layout();

	$(window).resize(layout);
	
	});
</script>

<script type="text/javascript">
/*  Initialize variable to keep changes*/
var changes={}
/*  Dimension of the last image sent by the server*/
var currentImageDim=parseInt('{{defaultZoom}}')
/*  If true images are regenerated in the server*/
var recallServer=false
/* Force regenerate even when src and data_real-src have the same value */
var forceRecallServer=false
/*  Last zoom set properly. In case the new value is too big or small it is set back to the previousZoom*/
var previousZoom='{{defaultZoom}}'
/* Initialize Table Layout Configuration from json variable*/
var jsonTableLayoutConfiguration = {{tableLayoutConfiguration|safe }}
console.log("json",jsonTableLayoutConfiguration)

$(document).ready(function(){ 
	
	
	{% if form.mode.value != 'column' and dataset.getNumberSlices > 0 %}
	setImageSize(true)
	initializeZoomEvents();
	{% if form.mode.value == 'gallery' %}
	initializeColRowModeEvents('{{form.mode.value}}')
	initializeColsRowsEvents()
	{% endif %}
	{% endif %}
	initializeComboBoxEvents('{{defaultZoom}}')
	initializeArrowEvents()
	initializeCheckboxEvents()
	
	/* Avoid enter key submit form */
	$('.menuInputNumber').keypress(function(e) {
	  var code = e.keyCode || e.which; 
	  if (code  == 13) {               
	    e.preventDefault();
	    return false;
	  }
	});
	
}); 
</script>
<script type="text/javascript">	
function setImageSize(refreshElement){
	/* Gets zoom and image width and height */
	zoom_element=$('#id_zoom')
	
	imageHeight_val = parseInt({{imageDimensions.1}})
	imageWidth_val = parseInt({{imageDimensions.0}})
	ratio = imageHeight_val/imageWidth_val 
	
	/* Check if zoom in pixel */
	if (zoom_element.val().indexOf('px')!=-1){
		/*  Get zoom value*/			
		zoom_val=parseInt(zoom_element.val().split('px')[0])
		
		/* Calculate zoom in percentage */
		if (imageHeight_val<imageWidth_val){
			tableImages_width=zoom_val
			zoom_val_perc=Math.round((zoom_val/imageWidth_val)*100)
		} 
		else{
			tableImages_width=Math.round(zoom_val*(imageWidth_val/imageHeight_val))+1
			zoom_val_perc=Math.round((zoom_val/imageHeight_val)*100)
		}
		
	}
	else{
		zoom_val_perc=zoom_element.val()
		if (imageHeight_val<imageWidth_val){
			zoom_val_pixel=Math.round((zoom_val_perc*imageWidth_val)/100)
			tableImages_width=zoom_val_pixel
		} 
		else{
			zoom_val_pixel=Math.round((zoom_val_perc*imageHeight_val)/100)
			tableImages_width=zoom_val_pixel
		}
	}
	
	/*  CHECK ZOOM VALUE IS A NUMBER BETWEEN MAX AND MIN*/
	tableImages_height=tableImages_width*ratio
		
	if (isNaN(tableImages_width) || tableImages_width>{{form.imageMaxWidth.value}} || tableImages_width<{{form.imageMinWidth.value}} || tableImages_height>{{form.imageMaxHeight.value}} || tableImages_height<{{form.imageMinHeight.value}}){
		alert('Incorrect table width or height: '+tableImages_width+'px x '+ tableImages_height +'px.')
		zoom_element.val(previousZoom)
		setImageSize(true)
		return;
	}
	else{
		previousZoom=tableImages_width+"px"
	}
	
	if (refreshElement==true){
		zoom_element.val(zoom_val_perc)
	}
	
	if (tableImages_width>currentImageDim*1.2 || tableImages_width<currentImageDim*0.8){
		recallServer=true
		currentImageDim=tableImages_width
	}	
	else{
		recallServer=false
	}
	
	d = new Date();
	$(".tableImages").each(function(){
	   	var newSrc = "";
	   	if ($(this).data("real_src").indexOf("&dim") != -1){
	   		newSrc = $(this).data("real_src").substring(0,$(this).data("real_src").indexOf("&dim"));
	   	}
	   	else{
			newSrc = $(this).data("real_src");   
	   	}
	   	$(this).attr("height",tableImages_width)
	   	$(this).attr("width",tableImages_width)
   	
   		realSrc = newSrc.concat("&dim="+tableImages_width).concat("&"+d.getTime())
		$(this).data("real_src", realSrc);
	   	
	   		 	

   })
   
   /* If images with new dimensions need to be generated in the server, waypoints jquery script manages it */
   if (recallServer){reloadImages(false)}
	
	if ($("#colRowModeImage").length >0 && $("#colRowModeImage").attr("src").indexOf("On")!=-1){initializeColsRows()}
}
</script>

	{% block head %}  {% endblock %}
{% endblock %}

{% block content_header %}	{% include "header.html" with page_mode="showj"%} {% endblock %}

{% block menu %}
<div id="asideMainContainer">
	<form id="showjForm" action="/showj/" method="post"> {% csrf_token %}
		<div id="modeContainer" class="sectionMenu">
			<!-- TABLE -->
			<input type="submit" value="table" name="select_mode" onclick="document.forms['showjForm'].id_mode.value='table';" class="submitButton
			 {% if form.mode.value != 'table' %}
			  tableOff
			 {% else %}
			  tableOn
			 {% endif %}	
			  " 
			  {% if form.mode.value == 'column' %}
			  disabled
			  {% endif %}
			  />
			
			<!-- GALLERY -->
			<input type="submit" value="gallery" name="select_mode" onclick="document.forms['showjForm'].id_mode.value='gallery';" class="submitButton
			 {% if form.mode.value != 'gallery'  %}
			  galleryOff
			 {% else %}
			  galleryOn
			 {% endif %}
			 
			 "
			 {% if form.mode.value == 'column' %}
			  disabled
			 {% endif %}
			 />
			 
			<!-- VOLUME VISUALIZE WITH ASTEX -->
			{% if dataset.getNumberSlices > 1 %} 
			<input type="submit" value="volume_astex" name="select_mode" onclick="document.forms['showjForm'].id_mode.value='volume_astex';" class="submitButton
			 {% if form.mode.value != 'volume_astex' %}
			 visualizeVolOff
			 {% else %}
			  visualizeVolOn
			 {% endif %}
			 "
			 />
			 {% endif %}
			 
			 <!-- VOLUME VISUALIZE WITH CHIMERA -->
			 {% if dataset.getNumberSlices > 1 %} 
			<input type="submit" value="volume_chimera" name="select_mode" onclick="document.forms['showjForm'].id_mode.value='volume_chimera';" class="submitButton
			 {% if form.mode.value != 'volume_chimera' %}
			 visualizeVolOff
			 {% else %}
			  visualizeVolOn
			 {% endif %}
			 "
			 
			   
			 />
			 {% endif %}
		</div>
		
		<div id="zoomContainer" class="sectionMenu">
			<!-- <img src="/resources/showj/zoom.png" class="menuIcon"> -->
			<i class="fa fa-search" style="margin-right:5px"></i>
			{{ form.zoom }}
			
			<div id="arrowContainer" class="arrowSectionMenu">
				<img src="/resources/showj/arrowUp.png" class="arrowImage">
				<img src="/resources/showj/arrowDown.png" class="arrowImage">
			</div>
			<!-- <input type="number" class="menuInputNumber" id="zoom" value="150" min="10"> -->
		</div>
		
		<div id="gotoContainer" class="sectionMenu">
			<img src="/resources/showj/goto.png" class="menuIcon">
			{{ form.goto }}
			
			<div id="arrowContainer" class="arrowSectionMenu">
				<img src="/resources/showj/arrowUp.png" class="arrowImage">
				<img src="/resources/showj/arrowDown.png" class="arrowImage">
			</div>
			<!-- <input type="number" class="menuInputNumber" id="goto" value="1" max="{{metadata.objects|length}}" min="1"> -->
		</div>
		
		<div class="sectionMenu">
			<img src="/resources/showj/separator.png" class="menuIcon">
		</div>	
		
		{% if form.mode.value == 'gallery' %}
		<div id="colRowContainer" class="sectionMenu">
			<button id="colRowMode"> 
				<img src="/resources/showj/colRowMode{{form.colRowMode.value}}.png" id="colRowModeImage" />
			</button>
			
			<div class="subSectionMenu" id="colsSubSectionMenu">
				<span class="textMenu">{{ form.cols.label_tag }}</span>
				{{ form.cols }}
				
				<div id="arrowContainer" class="arrowSectionMenu">
					<img src="/resources/showj/arrowUp.png" class="arrowImage">
					<img src="/resources/showj/arrowDown.png" class="arrowImage">
				</div>
				<!-- <input type="number" class="menuInputNumber" id="cols" value="" min="1" max="{{metadata.objects|length}}" disabled> -->
			</div>
			<div class="subSectionMenu" id="rowsSubSectionMenu">
				<span class="textMenu">{{ form.rows.label_tag }}</span>
				{{ form.rows }}
				
				<div id="arrowContainer" class="arrowSectionMenu">
					<img src="/resources/showj/arrowUp.png" class="arrowImage">
					<img src="/resources/showj/arrowDown.png" class="arrowImage">
				</div>
				<!-- <input type="number" class="menuInputNumber" id="rows" value="" min="1" max="{{metadata.objects|length}}" disabled> -->
			</div>
		</div>
		{% endif %}
		
		<div class="sectionMenu">
			<img src="/resources/showj/separator.png" class="menuIcon">
		</div>
	
		<div id="blockSelectorContainer" class="sectionMenu">
			<span class="textMenu"> {{ form.blockComboBox.label_tag }} </span>
			{{ form.blockComboBox }} 
		</div>
		
		<div id="metadataSelectorContainer" class="sectionMenu">
			<span class="textMenu">
			{% if not form.labelsToRenderComboBox.is_hidden %}
			{{ form.labelsToRenderComboBox.label_tag }}
			{% endif %}
			</span>
			{{ form.labelsToRenderComboBox }}
		</div>
		
		<div id="volumeSelectorContainer" class="sectionMenu">
			<span class="textMenu">
			{% if not form.volumesToRenderComboBox.is_hidden %}
			{{ form.volumesToRenderComboBox.label_tag }}
			{% endif %}
			</span>
			{{ form.volumesToRenderComboBox }}
		</div>
		
		<div id="resliceSelectorContainer" class="sectionMenu">
			<span class="textMenu">
			{% if not form.resliceComboBox.is_hidden %}
			{{ form.resliceComboBox.label_tag }}
			{% endif %}
			</span>
			{{ form.resliceComboBox }}
		</div>
	
		<div class="sectionMenu">
			<img src="/resources/showj/separator.png" class="menuIcon">
		</div>
		
		<div id="saveContainer" class="sectionMenu">
			<a id="saveButton" href="javascript:saveShowjTable('{{ csrf_token }}');" class="btn buttonGrey" style="padding: 5px 10px;"><i class="fa fa-save"></i></a>
		</div>
		
		
		<div id="optionsContainer" class="sectionMenu">
			<a id="optionsButton" href="javascript:showHideOptionMenu();" class="btn buttonGrey" style="padding: 5px 10px;"><i class="fa fa-wrench"></i></a>
			
			
			<!-- <button id="optionsButton" class="optionsOff submitButton" onclick="showHideOptionMenu(); return false;">
			</button> -->
		
			<ul id="optionsList">
				<li>{{ form.mirrorY }} {{ form.mirrorY.label_tag }}</li>
				<li>{{ form.applyTransformMatrix }} {{ form.applyTransformMatrix.label_tag }}</li>
				<li>{{ form.onlyShifts }} {{ form.onlyShifts.label_tag }}</li>
				<li>{{ form.wrap }} {{ form.wrap.label_tag }}</li>
			</ul>
		</div>  
		{% block content_menu %}	{% endblock %}
		 
		{% for hidden in form.hidden_fields %}
	    {{ hidden }}
	    {% endfor %} 
		 
	</form>
</div>	
{% endblock %}

{% block content %}	
{% block content_view %}	{% endblock %}	
			<!-- Hidden menu for multiple selection tool -->
			<div class="multipleSelectionToolContainer" id="multipleSelectionTool">
				{% if dataset.getTable.hasEnabledColumn %}
				<div class="multipleSelectionToolItem" onclick="multipleEnableDisableImage('enable')">Enable</div>
				<div class="multipleSelectionToolItem" onclick="multipleEnableDisableImage('disable')">Disable</div>
				{% endif %}
				<div class="multipleSelectionToolItem" onclick="multipleSelect('all')">Select All</div>
				<div class="multipleSelectionToolItem" onclick="multipleSelect('from')">Select From Here</div>
				<div class="multipleSelectionToolItem" onclick="multipleSelect('to')">Select To Here</div>
			</div>	

{% endblock %}	


